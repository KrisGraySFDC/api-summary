<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-summary test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../arc-polyfills/arc-polyfills.html">
  <script src="amf-loader.js"></script>
  <link rel="import" href="../api-summary.html">
  <link rel="import" href="../../raml-aware/raml-aware.html">
</head>

<body>
  <test-fixture id="Basic">
    <template>
      <api-summary aware="test"></api-summary>
    </template>
  </test-fixture>
  <test-fixture id="BaseUri">
    <template>
      <api-summary base-uri="https://domain.com"></api-summary>
    </template>
  </test-fixture>
  <test-fixture id="Aware">
    <template>
      <raml-aware scope="test"></raml-aware>
    </template>
  </test-fixture>
  <script>
  /* global AmfLoader */
  suite('api-summary', () => {
    suite('Basic', () => {
      let element;
      let amf;
      suiteSetup(() => {
        return AmfLoader.load()
          .then((data) => {
            amf = data;
          });
      });

      setup((done) => {
        element = fixture('Basic');
        element.amfModel = amf;
        flush(() => done());
      });

      test('raml-aware is in the DOM', () => {
        const node = element.shadowRoot.querySelector('raml-aware');
        assert.ok(node);
      });

      test('Computes apiTitle', () => {
        assert.equal(element.apiTitle, 'API body demo');
      });

      test('Computes version', () => {
        assert.equal(element.version, 'v1');
      });

      test('Computes hasVersion', () => {
        assert.isTrue(element.hasVersion);
      });

      test('Computes protocols', () => {
        assert.typeOf(element.protocols, 'array');
        assert.lengthOf(element.protocols, 2);
      });

      test('Computes hasProtocols', () => {
        assert.isTrue(element.hasProtocols);
      });

      test('Computes description', () => {
        assert.typeOf(element.description, 'string');
      });

      test('Computes apiBaseUri', () => {
        assert.equal(element.apiBaseUri, 'https://{instance}.domain.com');
      });
    });

    suite('Base URI property', () => {
      let element;
      let amf;
      suiteSetup(() => {
        return AmfLoader.load()
          .then((data) => {
            amf = data[0];
          });
      });

      function setupBaseUri(done) {
        element = fixture('BaseUri');
        element.amfModel = amf;
        flush(() => done());
      }

      function setupBasic(done) {
        element = fixture('Basic');
        element.amfModel = amf;
        flush(() => done());
      }

      teardown(() => {
        new Polymer.IronMeta({
          key: 'ApiBaseUri'
        }).value = undefined;
      });

      test('Sets URL from base uri', (done) => {
        setupBaseUri(() => {
          assert.equal(element.apiBaseUri, 'https://domain.com');
          done();
        });
      });

      test('Sets URL from iron-meta', (done) => {
        new Polymer.IronMeta({
          key: 'ApiBaseUri'
        }).value = 'https://meta.com/base';
        setupBasic(() => {
          assert.equal(element.apiBaseUri, 'https://meta.com/base');
          done();
        });
      });

      test('In case of conflict base uri wins', (done) => {
        new Polymer.IronMeta({
          key: 'ApiBaseUri'
        }).value = 'https://meta.com/base';
        setupBaseUri(() => {
          assert.equal(element.apiBaseUri, 'https://domain.com');
          done();
        });
      });
    });

    suite('OAS properties', () => {
      let amf;
      let element;
      suiteSetup(() => {
        return AmfLoader.load('loan-microservice.json')
          .then((data) => {
            amf = data;
          });
      });
      setup((done) => {
        element = fixture('Basic');
        element.amfModel = amf;
        flush(() => done());
      });

      test('hasProvider is computed', () => {
        assert.isTrue(element.hasProvider);
      });

      test('providerName is computed', () => {
        assert.typeOf(element.providerName, 'string');
      });

      test('providerEmail is computed', () => {
        assert.typeOf(element.providerEmail, 'string');
      });

      test('providerUrl is computed', () => {
        assert.typeOf(element.providerUrl, 'string');
      });

      test('Renders contact info region', () => {
        const node = element.shadowRoot.querySelector('[role="contentinfo"]');
        assert.ok(node);
      });

      test('hasLicense is computed', () => {
        assert.isTrue(element.hasLicense);
      });

      test('licenseName is computed', () => {
        assert.typeOf(element.licenseName, 'string');
      });

      test('licenseUrl is computed', () => {
        assert.typeOf(element.licenseUrl, 'string');
      });

      test('Renders license region', () => {
        const node = element.shadowRoot.querySelector('[aria-labelledby="licenseLabel"]');
        assert.ok(node);
      });

      test('termsOfService is computed', () => {
        assert.typeOf(element.termsOfService, 'string');
      });

      test('Renders ToS region', () => {
        const node = element.shadowRoot.querySelector('[aria-labelledby="tocLabel"]');
        assert.ok(node);
      });
    });

    suite('Endpoints map', () => {
      let amf;
      let element;
      const ENDPOINT_ID = 'amf://id#488';
      const METHOD_ID = 'amf://id#489';
      suiteSetup(() => {
        return AmfLoader.load('demo-api.json')
          .then((data) => {
            amf = data;
          });
      });

      setup((done) => {
        element = fixture('Basic');
        element.amfModel = amf;
        flush(() => done());
      });

      test('endpoints is computed', () => {
        assert.typeOf(element.endpoints, 'array');
        assert.lengthOf(element.endpoints, 11);
      });

      test('hasEndpoints is computed', () => {
        assert.isTrue(element.hasEndpoints);
      });

      test('Endpoint has name', () => {
        const result = element.endpoints[2];
        assert.equal(result.name, 'People');
      });

      test('Endpoint has path', () => {
        const result = element.endpoints[2];
        assert.equal(result.path, '/people');
      });

      test('Endpoint has id', () => {
        const result = element.endpoints[2];
        assert.typeOf(result.id, 'string');
      });

      test('Endpoint has ops - list of operations', () => {
        const result = element.endpoints[2];
        assert.typeOf(result.ops, 'array');
        assert.lengthOf(result.ops, 3);
      });

      test('Operation has id', () => {
        const result = element.endpoints[2].ops[0];
        assert.typeOf(result.id, 'string');
      });

      test('Operation has method name', () => {
        const result = element.endpoints[2].ops[0];
        assert.equal(result.method, 'get');
      });

      test('Click on an endpoint dispatches navigation event', (done) => {
        const node = element.shadowRoot.querySelector(`.endpoint-label[data-id]`);
        element.addEventListener('api-navigation-selection-changed', (e) => {
          assert.typeOf(e.detail.selected, 'string');
          assert.equal(e.detail.type, 'endpoint');
          done();
        });
        node.click();
      });

      test('Click on an endpoint path dispatches navigation event', (done) => {
        const node = element.shadowRoot.querySelector(`.endpoint-path[data-id]`);
        element.addEventListener('api-navigation-selection-changed', (e) => {
          assert.typeOf(e.detail.selected, 'string');
          assert.equal(e.detail.type, 'endpoint');
          done();
        });
        node.click();
      });

      test('Click on a method dispatches navigation event', (done) => {
        const node = element.shadowRoot.querySelector(`.method-label[data-id]`);
        element.addEventListener('api-navigation-selection-changed', (e) => {
          assert.typeOf(e.detail.selected, 'string');
          assert.equal(e.detail.type, 'method');
          done();
        });
        node.click();
      });
    });

    suite('_computeBaseUri()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Calls helper method _getBaseUri()', () => {
        const spy = sinon.spy(element, '_getBaseUri');
        element._computeBaseUri({}, 'https://api.com');
        assert.isTrue(spy.called);
      });

      test('Returns a string', () => {
        const result = element._computeBaseUri({}, 'https://api.com/api');
        assert.equal(result, 'https://api.com/api');
      });

      test('Removes trailing slash', () => {
        const result = element._computeBaseUri({}, 'https://api.com/');
        assert.equal(result, 'https://api.com');
      });

      test('Returns default string when no base URI', () => {
        const result = element._computeBaseUri({});
        assert.equal(result, 'Base URI not defined in the API file.');
      });
    });

    suite('_displayArray()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Returns undefined when no arguments', () => {
        const result = element._displayArray();
        assert.isUndefined(result);
      });

      test('Returns undefined when empty array', () => {
        const result = element._displayArray([]);
        assert.isUndefined(result);
      });

      test('Returns original value if not array', () => {
        const result = element._displayArray('test');
        assert.equal(result, 'test');
      });

      test('Returns processed array', () => {
        const result = element._displayArray(['a', 'b']);
        assert.equal(result, 'a, b');
      });
    });

    suite('_computeProvider()', () => {
      let model;
      let element;
      setup(() => {
        element = fixture('Basic');
        model = {
          'http://schema.org/provider': [{
            '@id': 'amf://id#369',
            '@type': [
              'http://schema.org/Organization',
              'http://a.ml/vocabularies/document#DomainElement'
            ],
            'http://schema.org/url': [{
              '@id': 'http://domain.com'
            }],
            'http://schema.org/name': [{
              '@value': 'John Doe'
            }],
            'http://schema.org/email': [{
              '@value': 'test@mail.com'
            }]
          }]
        };
      });

      test('Computes provider model', () => {
        const result = element._computeProvider(model);
        assert.typeOf(result, 'object');
      });

      test('Removes nested array', () => {
        const p = [Object.assign({}, model['http://schema.org/provider'][0])];
        model['http://schema.org/provider'][0] = p;
        const result = element._computeProvider(model);
        assert.typeOf(result, 'object');
      });
    });

    suite('_copyPathClipboard()', () => {
      let element;
      setup((done) => {
        element = fixture('Basic');
        flush(() => done());
      });

      test('Calls copy() in the `clipboard-copy` element', () => {
        const copy = element.shadowRoot.querySelector('#pathCopy');
        const spy = sinon.spy(copy, 'copy');
        element._copyPathClipboard();
        assert.isTrue(spy.called);
      });

      test('Changes the icon', () => {
        element._copyPathClipboard();
        const button = element.shadowRoot.querySelector('.copy-icon');
        assert.notEqual(button.icon, 'arc:content-copy');
      });

      test('Changes the icon back', (done) => {
        element._copyPathClipboard();
        setTimeout(() => {
          const button = element.shadowRoot.querySelector('.copy-icon');
          assert.equal(button.icon, 'arc:content-copy');
          done();
        }, 1001);
      });
    });

    suite('a11y', () => {
      let aware;
      suiteSetup(() => {
        return AmfLoader.load('loan-microservice.json')
          .then((data) => {
            aware = fixture('Aware');
            aware.raml = data;
          });
      });

      a11ySuite('Basic');
    });
  });
  </script>
</body>

</html>
